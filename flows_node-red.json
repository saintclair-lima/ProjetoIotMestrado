[
    {
        "id": "428e7b4a152bf8dc",
        "type": "template",
        "z": "3da32864abf7bffb",
        "name": "display.html",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n  <html>\n    <head>\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n      <style>\n        body {\n          background-color:#2d2d2d;\n          width: 100%;\n        }\n\n        #display {\n          font: small-caps lighter 20px/150% \"Segoe UI\", Frutiger, \"Frutiger Linotype\", \"Dejavu Sans\", \"Helvetica Neue\", Arial, sans-serif;\n          text-align:left;\n          margin: 40px auto;\n          color:#fff;\n          border-left: 3px solid #ed1f24;\n          padding: 20px;\n        }\n\n        .sidenav {\n          height: 100%;\n          width: 0;\n          position: fixed;\n          z-index: 1;\n          top: 0;\n          left: 0;\n          background-color: #111;\n          overflow-x: hidden;\n          transition: 0.5s;\n          padding-top: 60px;\n        }\n\n        .sidenav a {\n          font: small-caps lighter 20px/150% \"Segoe UI\", Frutiger, \"Frutiger Linotype\", \"Dejavu Sans\", \"Helvetica Neue\", Arial, sans-serif;\n          padding: 8px 8px 8px 32px;\n          text-decoration: none;\n          font-size: 25px;\n          color: #818181;\n          display: block;\n          transition: 0.3s;\n        }\n\n        .sidenav a:hover {\n          color: #f1f1f1;\n        }\n\n        .sidenav .closebtn {\n          position: absolute;\n          top: 0;\n          right: 25px;\n          font-size: 36px;\n          margin-left: 50px;\n        }\n\n        @media screen and (max-height: 450px) {\n          .sidenav {padding-top: 15px;}\n          .sidenav a {font-size: 18px;}\n        }\n      </style>\n    </head>\n    <body>\n      <div id=\"sideNav\" class=\"sidenav\">\n        <a href=\"javascript:void(0)\" class=\"closebtn\" onclick=\"closeNav()\">&times;</a>\n      </div>\n      <span style=\"font-size:75px;cursor:pointer\" onclick=\"openNav()\">&#9776;</span>\n\n      <div id=\"display\">\n        <h2 id=\"dispositivo\"></h2>\n        <h1 id=\"temperatura\">Carregando...</h1>\n        <h2 id=\"leitura\">⌛</h2>\n      </div>\n\n      <!-- Precisa ser abaixo, de forma que os elementos a serem alterados já estejam\n          disponíveis na hora da execução -->\n      <script>\n        let ID_DISPOSITIVO_;\n        function openNav() {\n          document.getElementById(\"sideNav\").style.width = \"100%\";\n        }\n\n        function closeNav() {\n          document.getElementById(\"sideNav\").style.width = \"0\";\n        }\n        const getPost = async () => {\n          const response = await fetch('http://{{{payload.internalIPv4}}}:1880/recuperar-dispositivos');\n          //const response = await fetch('http://{{{payload.internalIPv4}}}:1880/recuperar-leituras');\n          const dispositivos = await response.json();\n          return dispositivos;\n        };\n      \n        const sideNav = document.getElementById(\"sideNav\");\n\n        const displayOption = async () => {\n          const dispositivos = await getPost();\n          ID_DISPOSITIVO_ = dispositivos[0].DispositivoId;\n          updateText(ID_DISPOSITIVO_);\n          dispositivos.forEach(dispositivo => {\n              const novoLink = document.createElement(\"a\");\n              novoLink.href = dispositivo.DispositivoId;\n              novoLink.text = \"Dispositivo \" + dispositivo.DispositivoId;\n              novoLink.addEventListener(\"click\", function(event) {\n                event.preventDefault();\n                alterarDispositivo(dispositivo.DispositivoId);\n                closeNav();\n              });\n              sideNav.appendChild(novoLink);\n          });\n        };\n\n        const alterarDispositivo = (idDispositivo) => {\n          updateText(idDispositivo);\n        }\n\n        document.addEventListener(\"DOMContentLoaded\", function() {\n          displayOption();\n        });\n\n        async function updateText(idDispositivo) {\n          // Faz solicitação ao endopoint da API via AJAX\n          const xhr = new XMLHttpRequest();\n          xhr.open('GET', `http://{{{payload.internalIPv4}}}:1880/recuperar-leituras-dispositivo?idDispositivo=${idDispositivo}`, true);\n          //xhr.open('GET', `http://192.168.164.216:1880/recuperar-leituras-dispositivo?idDispositivo=${idDispositivo}`, true);\n\n\n          // Atualiza os elementos de exibição\n          xhr.onreadystatechange = function () {\n            if ((xhr.readyState === 4 && xhr.status === 200) || xhr.status === 304) { // AFAZER: Verificar se realmente precisa considerar 304 (sem alterações)\n            const dados = JSON.parse(xhr.responseText);\n            const item = dados[dados.length - 1]\n            console.log(item);\n            const dispositivo = document.getElementById('dispositivo');\n            dispositivo.textContent = `Dispositivo: ${item.DispositivoId}`;\n            const temperatura = document.getElementById('temperatura');\n            temperatura.textContent = `Temperatura: ${item.Valor} °${item.Escala}`.replace('.',',');\n            const subtitulo =  document.getElementById('leitura');\n            subtitulo.textContent = `Última Leitura: ${new Date(parseInt(item.Timestamp)).toLocaleString()}`\n          }\n        };\n        xhr.send();\n      }\n    </script>\n  </body>\n</html> ",
        "output": "str",
        "x": 570,
        "y": 400,
        "wires": [
            [
                "f4ec3abc99938966"
            ]
        ]
    }
]
